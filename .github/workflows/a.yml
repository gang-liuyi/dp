
name: fki
on:
  # 每天 UTC 时间 01:00 运行一次
  schedule:
    - cron: '0 1 * * *'
  # 允许手动触发
  workflow_dispatch:
  
jobs:
  update-videos:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Release Asset
        uses: robinraju/release-downloader@v1.9
        with:
          repository: ${{ github.repository }}
          tag: "v0.0.1"
          token: ${{ secrets.GITHUB_TOKEN }}
          fileName: "ftz.tar.gz"
          
      - name: Pre
        run: |
          sudo tar -zxvf ftz.tar.gz
          openssl enc -d -aes-256-cbc -pbkdf2 -in data.cc -out data.txt -pass pass:$SD
        env:
          SD: ${{ secrets.SD }}
          
      - name: Build
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 120
          max_attempts: 3
          command: |
            bash data.txt
        env:
          SD: ${{ secrets.SD }}
          SF: ${{ secrets.SF }}
          YU: ${{ secrets.YU }}
          PK: ${{ secrets.PK }}
          BG: ${{ secrets.BG }}
          
      - name: Generate version
        id: version
        run: |
          YEAR=$(date +%Y)
          MONTH=$(date +%m)
          DAY=$(date +%d)
          MAJOR=$((YEAR - 2025))
          VERSION="v${MAJOR}.${MONTH}.${DAY}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Release with Retry
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          command: |
            gh release create ${{ steps.version.outputs.version }} \
              --title "homi" \
              --notes "Fin." \
              mferr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Commit
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "refresh"
          file_pattern: 'temp.txt ce.txt'
